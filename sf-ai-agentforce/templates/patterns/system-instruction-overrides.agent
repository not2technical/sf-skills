# System Instruction Overrides Pattern
# Customize agent behavior with dynamic system-level instructions
#
# ★ When To Use This Pattern:
#   - Different behavior for different user segments (VIP, standard, etc.)
#   - Time-based instruction changes (business hours vs after hours)
#   - Feature flags that change agent personality
#   - A/B testing different conversation styles
#
# ★ Key Insight:
#   - System block defines BASE behavior (always applies)
#   - Topic instructions can OVERRIDE or EXTEND system behavior
#   - Use conditionals in reasoning to dynamically adjust tone
#   - Variables can control instruction branches
#
# ★ Important Limitation:
#   - The system: block itself cannot use conditionals or variables
#   - Dynamic behavior must be implemented in topic reasoning
#
# This is a COMPLETE template - customize for your use case

system:
   # Base instructions - always apply these guardrails
   instructions: "You are a professional customer service agent. Always be helpful, courteous, and accurate. Never share confidential information. Escalate complex issues to human agents."
   messages:
      welcome: "Hello! How can I assist you today?"
      error: "I apologize, but I encountered an issue. Let me try that again."

config:
   agent_name: "Dynamic_Service_Agent"
   default_agent_user: "agent@company.salesforce.com"
   agent_label: "Dynamic Service Agent"
   description: "Agent with dynamic instruction overrides based on context"

variables:
   # Standard linked variables
   EndUserId: linked string
      source: @MessagingSession.MessagingEndUserId
      description: "Messaging End User ID"
   RoutableId: linked string
      source: @MessagingSession.Id
      description: "Messaging Session ID"
   ContactId: linked string
      source: @MessagingEndUser.ContactId
      description: "Contact ID"

   # Variables for dynamic instruction control
   customer_tier: mutable string = "standard"
      description: "Customer tier: standard, premium, or vip"
   business_hours: mutable boolean = True
      description: "Whether we're in business hours"
   agent_mode: mutable string = "helpful"
      description: "Agent personality mode: helpful, concise, formal"
   feature_flags: mutable string = ""
      description: "Comma-separated feature flags"

language:
   default_locale: "en_US"
   additional_locales: ""
   all_additional_locales: False

start_agent topic_selector:
   label: "Topic Selector"
   description: "Routes to appropriate topic based on user tier"

   # ★ Use before_reasoning to set up context-based variables
   before_reasoning:
      # In a real implementation, these would come from a Flow/Apex lookup
      # Here we show the pattern
      run @actions.get_customer_tier
         with contact_id=@variables.ContactId
         set @variables.customer_tier = @outputs.tier
      run @actions.check_business_hours
         set @variables.business_hours = @outputs.is_business_hours

   reasoning:
      # ★ OVERRIDE PATTERN: Conditional instructions based on variables
      instructions: ->
         # VIP customers get personalized treatment
         if @variables.customer_tier == "vip":
            | PRIORITY CUSTOMER DETECTED
            | Provide white-glove service. Use their name when possible.
            | Offer proactive solutions. Never say "I can't" without an alternative.
            | You have authority to offer 20% discounts.

         # Premium gets enhanced support
         if @variables.customer_tier == "premium":
            | PREMIUM CUSTOMER
            | Provide thorough, detailed responses.
            | Offer to connect with a specialist if needed.
            | You can offer 10% discounts.

         # Standard tier
         if @variables.customer_tier == "standard":
            | Provide helpful, efficient service.
            | Focus on resolving the issue quickly.

         # After-hours override
         if @variables.business_hours == False:
            | NOTE: We are currently outside business hours.
            | Complex issues should be logged for follow-up tomorrow.
            | You cannot transfer to live agents right now.

         # Mode-based personality adjustments
         if @variables.agent_mode == "concise":
            | Keep responses brief and to the point. Use bullet points.

         if @variables.agent_mode == "formal":
            | Use formal language. Address customer as Sir/Madam.

         | Route the customer to the appropriate topic.

      actions:
         go_orders: @utils.transition to @topic.orders
         go_billing: @utils.transition to @topic.billing
         go_support: @utils.transition to @topic.support
            available when @variables.business_hours == True

   actions:
      get_customer_tier:
         description: "Get customer tier from Salesforce"
         inputs:
            contact_id: string
               description: "Contact ID to look up"
         outputs:
            tier: string
               description: "Customer tier: standard, premium, vip"
         target: "flow://Get_Customer_Tier"

      check_business_hours:
         description: "Check if currently in business hours"
         outputs:
            is_business_hours: boolean
               description: "True if in business hours"
         target: "flow://Check_Business_Hours"

topic orders:
   label: "Order Management"
   description: "Handle order inquiries with tier-appropriate service"

   reasoning:
      instructions: ->
         # ★ Tier-specific instructions carry through to subtopics
         if @variables.customer_tier == "vip":
            | This is a VIP customer. Expedite all order requests.
            | Offer free shipping upgrades proactively.

         | Help the customer with their order inquiry.
         | Look up order status, process changes, or handle returns.

      actions:
         back: @utils.transition to @topic.topic_selector

topic billing:
   label: "Billing Support"
   description: "Handle billing with appropriate authority levels"

   reasoning:
      instructions: ->
         # ★ Different authority based on tier
         if @variables.customer_tier == "vip":
            | You can waive fees up to $100 for VIP customers.
            | Proactively offer payment plan options.

         if @variables.customer_tier == "premium":
            | You can waive fees up to $25 for premium customers.

         if @variables.customer_tier == "standard":
            | Fee waivers require manager approval. Escalate if requested.

         | Help the customer understand their bill and resolve issues.

      actions:
         back: @utils.transition to @topic.topic_selector
         escalate: @utils.escalate
            description: "Transfer to billing specialist"
            available when @variables.customer_tier == "standard"

topic support:
   label: "Technical Support"
   description: "Technical support with business hours awareness"

   reasoning:
      instructions: ->
         if @variables.business_hours == False:
            | Technical support is limited outside business hours.
            | Log the issue for follow-up and provide self-service resources.

         if @variables.business_hours == True:
            | Full technical support available. Troubleshoot thoroughly.

         | Help resolve the customer's technical issue.

      actions:
         back: @utils.transition to @topic.topic_selector

# ★ Insight: System vs Topic Instructions
#
# SYSTEM BLOCK:
#   - Static text only (no variables, no conditionals)
#   - Applies to ALL topics as baseline
#   - Good for: Guardrails, base personality, universal rules
#
# TOPIC REASONING:
#   - Dynamic (variables, conditionals, template expressions)
#   - Can override/extend system behavior per topic
#   - Good for: Context-aware responses, personalization
#
# Best Practice: Put guardrails in system, personalization in topics
